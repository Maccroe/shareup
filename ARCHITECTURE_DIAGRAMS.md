# iOS WebRTC Fix - Architecture Diagrams

## System Architecture: Before vs After

### BEFORE (Broken on iOS)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      iOS Safari (400MB limit)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  PC sends 16KB chunk                                         â”‚
â”‚         â†“                                                     â”‚
â”‚  Browser receives chunk                                      â”‚
â”‚         â†“                                                     â”‚
â”‚  âŒ chunks.push(chunk)  â† Stored in RAM!                     â”‚
â”‚         â†“                                                     â”‚
â”‚  Repeat 34,728 times...                                      â”‚
â”‚         â†“                                                     â”‚
â”‚  RAM: 556MB                                                  â”‚
â”‚         â†“                                                     â”‚
â”‚  const blob = new Blob(chunks)  â† Another 556MB!            â”‚
â”‚         â†“                                                     â”‚
â”‚  Total RAM: 1GB+                                             â”‚
â”‚         â†“                                                     â”‚
â”‚  ğŸ’¥ CRASH (exceeded 400MB limit)                             â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AFTER (Works on iOS)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           iOS Safari (400MB) + IndexedDB (Disk Storage)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Browser RAM        â”‚         IndexedDB (Disk)                 â”‚
â”‚   (~100MB peak)      â”‚         (556MB available)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      â”‚                                           â”‚
â”‚  PC sends 16KB       â”‚                                           â”‚
â”‚      â†“               â”‚                                           â”‚
â”‚  Device check        â”‚                                           â”‚
â”‚      â†“               â”‚                                           â”‚
â”‚  Is iOS? YES         â”‚                                           â”‚
â”‚      â†“               â”‚                                           â”‚
â”‚  âœ… saveChunk(      â”‚  Chunk #1: 16KB                           â”‚
â”‚     fileId,         â”‚  Chunk #2: 16KB                           â”‚
â”‚     index,          â”‚  Chunk #3: 16KB                           â”‚
â”‚     data)           â”‚  ...                                       â”‚
â”‚      â†“               â”‚  Chunk #34728: 16KB                      â”‚
â”‚  RAM: 16KB only!    â”‚  Total: 556MB                             â”‚
â”‚      â†“               â”‚                                           â”‚
â”‚  Repeat 34,728x     â”‚                                           â”‚
â”‚      â†“               â”‚                                           â”‚
â”‚  Transfer complete  â”‚                                           â”‚
â”‚      â†“               â”‚                                           â”‚
â”‚  blob = await       â”‚  Read all chunks (sorted)                 â”‚
â”‚  getFileFromDB()    â”‚  âœ… Assemble Blob from disk              â”‚
â”‚      â†“               â”‚                                           â”‚
â”‚  RAM peak: <100MB   â”‚                                           â”‚
â”‚      â†“               â”‚                                           â”‚
â”‚  âœ… NO CRASH!       â”‚                                           â”‚
â”‚                      â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagram

### High Level Flow

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  PC (Sender) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ WebRTC
                           â”‚ (32KB chunks)
                           â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Browser    â”‚
                    â”‚  Device Chk  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â†“                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ iOS Safari?  â”‚      â”‚ Android etc? â”‚
        â”‚    YES       â”‚      â”‚     NO       â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                     â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â†“â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â†“â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ 16KB chunks     â”‚    â”‚ 32KB chunks  â”‚
      â”‚ LOW backpressureâ”‚    â”‚ STD buffer   â”‚
      â”‚ Stream to disk  â”‚    â”‚ Buffer RAM   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                    â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â†“â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â†“â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ IndexedDB       â”‚    â”‚ Memory +     â”‚
      â”‚ (chunks store)  â”‚    â”‚ IndexedDB    â”‚
      â”‚ Disk storage    â”‚    â”‚ (recovery)   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Transfer Completeâ”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Assemble Final Blob     â”‚
         â”‚  iOS: from IndexedDB     â”‚
         â”‚  Other: from Memory      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ Download Ready        â”‚
           â”‚ User clicks Download  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Save to Device Storage   â”‚
        â”‚ Clean up IndexedDB       â”‚
        â”‚ âœ… Complete             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Memory Usage Over Time

### OLD (Broken)

```
RAM Usage
â”‚
â”‚    â–²
â”‚    â”‚  â•±â•²
â”‚    â”‚ â•±  â•²  â† ğŸ’¥ CRASH!
â”‚556â”‚â•±    â•²  (exceeds 400MB)
â”‚    â”‚     â•²
â”‚400â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â•²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚    â”‚         â•²   â† Limit
â”‚300â”‚          â•²
â”‚200â”‚           â•²
â”‚100â”‚            â•²___
â”‚    â”‚________________ Time
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   File transfer â†’ CRASH
```

### NEW (Works)

```
RAM Usage
â”‚
â”‚  â–²
â”‚  â”‚  â•±â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â•²
â”‚  â”‚ â•±               â•²  â† Peak <100MB
â”‚ 100â”‚â•±                 â•²___
â”‚    â”‚                      â•²_
â”‚400â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Limit
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚    â”‚
â”‚ 16 â”‚â†â”€â”€ Chunk size
â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Time
          File transfer â†’ âœ… Success!

     [IndexedDB: 556MB on disk]
```

---

## Decision Tree: iOS vs Android

```
                    File Received
                         â”‚
                         â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Check User Device    â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â†“                     â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ iOS Safari?  â”‚     â”‚   Android    â”‚
    â”‚   (check UA) â”‚     â”‚   Chrome etc â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚
           â†“                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Streaming Mode   â”‚  â”‚ Memory Mode  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                     â”‚
           â†“                     â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Chunk Size:     â”‚ â”‚ Chunk Size:    â”‚
    â”‚ 16KB            â”‚ â”‚ 32KB           â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚
           â†“                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Buffer Limits:  â”‚ â”‚ Buffer Limits: â”‚
    â”‚ HIGH: 256KB     â”‚ â”‚ HIGH: 256-2MB  â”‚
    â”‚ LOW:  128KB     â”‚ â”‚ LOW:  128-1MB  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚
           â†“                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Store to:       â”‚ â”‚ Store to:      â”‚
    â”‚ IndexedDB       â”‚ â”‚ Memory +       â”‚
    â”‚ (disk)          â”‚ â”‚ IndexedDB      â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚
           â†“                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Assemble from:  â”‚ â”‚ Assemble from: â”‚
    â”‚ Disk (from DB)  â”‚ â”‚ RAM (memory)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ Blob Ready      â”‚
           â”‚ Download works  â”‚
           â”‚ âœ… Success      â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Chunk Storage Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            IndexedDB Structure (v2)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  Database: shareup_files_db                         â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Store 1: received_files             â”‚            â”‚
â”‚  â”‚ (For crash recovery after transfer) â”‚            â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚  â”‚ id: "timestamp-filename"            â”‚            â”‚
â”‚  â”‚ name: "video.mp4"                   â”‚            â”‚
â”‚  â”‚ size: 556000000                     â”‚            â”‚
â”‚  â”‚ blob: Blob                          â”‚            â”‚
â”‚  â”‚ timestamp: 1702299600000            â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Store 2: file_chunks                â”‚            â”‚
â”‚  â”‚ (For streaming on iOS)              â”‚            â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚  â”‚ id: "fileId:0"                      â”‚            â”‚
â”‚  â”‚ fileId: "1702299600000-video.mp4"   â”‚            â”‚
â”‚  â”‚ chunkIndex: 0                       â”‚            â”‚
â”‚  â”‚ data: ArrayBuffer(16384)            â”‚            â”‚
â”‚  â”‚ ---                                  â”‚            â”‚
â”‚  â”‚ id: "fileId:1"                      â”‚            â”‚
â”‚  â”‚ fileId: "1702299600000-video.mp4"   â”‚            â”‚
â”‚  â”‚ chunkIndex: 1                       â”‚            â”‚
â”‚  â”‚ data: ArrayBuffer(16384)            â”‚            â”‚
â”‚  â”‚ ---                                  â”‚            â”‚
â”‚  â”‚ ... (34728 chunks total)             â”‚            â”‚
â”‚  â”‚ ---                                  â”‚            â”‚
â”‚  â”‚ id: "fileId:34727"                  â”‚            â”‚
â”‚  â”‚ fileId: "1702299600000-video.mp4"   â”‚            â”‚
â”‚  â”‚ chunkIndex: 34727                   â”‚            â”‚
â”‚  â”‚ data: ArrayBuffer(16384)            â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Function Call Sequence

### iOS Safari: Receiving 556MB File

```
1. handleFileInfo(message)
   â”œâ”€ Check: isIOSSafari = true
   â”œâ”€ Set: useIndexedDBStreaming = true
   â””â”€ Set: chunks = null (don't use array!)

2. handleBinaryChunk(data)  â† Called 34,728 times
   â”œâ”€ Check: useIndexedDBStreaming = true
   â”œâ”€ await saveChunkToIndexedDB(fileId, index, data)
   â”‚  â””â”€ IndexedDB: store.put(chunkRecord)
   â””â”€ (RAM usage: only 16KB!)

3. handleFileComplete(message)
   â”œâ”€ Check: useIndexedDBStreaming = true
   â”œâ”€ blob = await getFileFromIndexedDB(fileId)
   â”‚  â”œâ”€ Read all chunks from IndexedDB
   â”‚  â”œâ”€ Sort by chunkIndex
   â”‚  â””â”€ new Blob(sortedChunks)
   â”œâ”€ displayReceivedFile(file)
   â”œâ”€ await persistReceivedFile(file)
   â”œâ”€ await clearChunksFromIndexedDB(fileId)
   â””â”€ currentTransfer = null

4. downloadFile(fileName)
   â”œâ”€ Get blob from receivedFiles
   â”œâ”€ url = URL.createObjectURL(blob)
   â”œâ”€ Trigger download via <a> element
   â”œâ”€ await deleteReceivedFileFromDB(fileId)
   â””â”€ showToast: "âœ… File downloaded successfully"
```

### Android: Receiving 556MB File

```
1. handleFileInfo(message)
   â”œâ”€ Check: isIOSSafari = false
   â”œâ”€ Set: useIndexedDBStreaming = false
   â””â”€ Set: chunks = [] (use array)

2. handleBinaryChunk(data)  â† Called 17,344 times
   â”œâ”€ Check: useIndexedDBStreaming = false
   â”œâ”€ this.currentTransfer.chunks.push(data)  â† In RAM
   â””â”€ (RAM grows: 32KB Ã— 17,344 = 556MB)

3. handleFileComplete(message)
   â”œâ”€ Check: useIndexedDBStreaming = false
   â”œâ”€ blob = new Blob(chunks)  â† From memory
   â”œâ”€ displayReceivedFile(file)
   â”œâ”€ await persistReceivedFile(file)
   â””â”€ (chunks now also in IndexedDB for recovery)

4. downloadFile(fileName)
   â”œâ”€ Get blob from receivedFiles
   â”œâ”€ url = URL.createObjectURL(blob)
   â”œâ”€ Trigger download via <a> element
   â”œâ”€ await deleteReceivedFileFromDB(fileId)
   â””â”€ showToast: "âœ… File downloaded successfully"
```

---

## Error Handling & Fallbacks

```
Try: saveChunkToIndexedDB()
â”œâ”€ Success â†’ Chunk persisted to disk
â””â”€ Fail â†’
   â”œâ”€ Log error: "Failed to save chunk to IndexedDB"
   â”œâ”€ Fallback: this.currentTransfer.chunks.push(data)
   â””â”€ Continue with memory buffering (degrades gracefully)

Try: getFileFromIndexedDB()
â”œâ”€ Success â†’ Blob from IndexedDB chunks
â””â”€ Fail â†’
   â”œâ”€ Log error: "Failed to retrieve file from IndexedDB"
   â”œâ”€ Fallback: new Blob(fallback_chunks)
   â””â”€ Use any in-memory chunks if available

Try: clearChunksFromIndexedDB()
â”œâ”€ Success â†’ Storage freed
â””â”€ Fail â†’
   â”œâ”€ Log warning: "Failed to clear chunks from IndexedDB"
   â””â”€ Continue anyway (storage will accumulate, user can clear)
```
